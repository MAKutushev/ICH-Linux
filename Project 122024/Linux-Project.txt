Отчёт о восстановлении работоспособности Linux-сервера

Описание задачи

Задача заключалась в восстановлении работы веб-сервера на Linux, который прекратил свою работу, хотя на сервере функционируют веб-приложение и веб-сервер Apache, а также настроены резервные копии. Было необходимо восстановить сервисы и выявить причины сбоя.

Этапы работы:

Проверка доступности веб-сайта
Мы получили ссылку на сервер (http://18.192.103.67/), при попытке подключиться к сайту стало понятно, что он не работает.

Подключение к серверу через SSH
Для того чтобы подключиться к серверу, использовалась следующая команда:

ssh -i ich.pem ec2-user@18.192.103.67

-i ich.pem указывает на использование приватного ключа для аутентификации, который необходим для безопасного подключения.
ec2-user — это имя пользователя, через которое происходит вход на сервер.
Проверка статуса веб-сервера Apache
Для проверки состояния веб-сервера использовался следующий запрос:

sudo service httpd status
Эта команда показывает статус сервиса Apache (httpd). Мы увидели, что сервис не работает (статус: inactive).

Запуск веб-сервера Apache
После того как убедились, что сервис Apache не активен, его можно было запустить с помощью команды:

sudo service httpd start
Проверив снова статус, убедились, что сервис был успешно запущен и работает.

Проверка конфигурации приложения
Настройки приложения находились в файле, расположенном по следующему пути:

/home/ec2-user/LocalSettings\ \(5\).php
Этот файл должен был быть скопирован в директорию /var/www/html/mediawiki/, но при попытке копирования возникла ошибка из-за недостаточного пространства на диске:

cp /home/ec2-user/LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php
Ошибка: No space left on device (Нет места на устройстве).

Освобождение дискового пространства
Проверка свободного места:

df -h
Эта команда показывает использование дискового пространства на сервере. Мы заметили, что раздел /dev/nvme0n1p1 был полностью заполнен.

Чтобы найти большие файлы, мы использовали команду:

find / -type f -size +100M

-type f ищет только файлы,
-size +100M находит файлы размером более 100 МБ.
При поиске было обнаружено, что файл логов Apache (/var/log/httpd/access_log) занимал 7 ГБ.

Очистка файла логов
Для того чтобы освободить место на диске, файл логов был очищен с помощью команды:


sudo echo "" > /var/log/httpd/access_log
После этого свободное место на диске было восстановлено.

Корректировка конфигурационного файла
После того как место было освобождено, файл конфигурации LocalSettings.php был успешно скопирован в нужную директорию. В конфигурации также был исправлен IP-адрес, который нужно было обновить на актуальный для работы приложения.

Настройка автоматической очистки логов
Для автоматической очистки логов был написан скрипт:


#!/bin/bash

LOG_DIR="/var/log/httpd"
LOG_FILE="access_log"
BACKUP_DIR="/var/backups"
MAX_BACKUPS=3
DATE=$(date +%Y%m%d)
ARCHIVE="$BACKUP_DIR/$LOG_FILE-$DATE.tar.gz"

tar -czf "$ARCHIVE" "$LOG_DIR/$LOG_FILE"
find "$BACKUP_DIR" -type f -name "$LOG_FILE-*.tar.gz" -mtime +3 -exec rm {} \;
Этот скрипт:

Архивирует файлы логов в указанный каталог,
Удаляет старые архивы, которые старше 3 дней.
Затем был добавлен cron-запуск скрипта ежедневно в полночь:

0 0 * * * /home/ec2-user/backup_logs.sh

В результате выполнения всех шагов были решены следующие задачи:

Перезапуск веб-сервера Apache,
Освобождение дискового пространства,
Исправление конфигурации приложения,
Настройка автоматического архивирования логов.
Сайт был восстановлен и снова стал доступен для пользователей.

